<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Javascript学习12 | 保的城</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="languages are still build from a lexer,a parser and a compiler。
绝大多数的动态语言都是分成四部分的:the lexer,the parser,the interpreter and the runtime.
我们将要创造的语言叫Awesome，使用Ruby语法和Python缩进，长下面模样：
123456789101112131415">
<meta property="og:type" content="article">
<meta property="og:title" content="Javascript学习12">
<meta property="og:url" content="http:www.balsam.xyz/2015/12/javascript-learn-12/index.html">
<meta property="og:site_name" content="保的城">
<meta property="og:description" content="languages are still build from a lexer,a parser and a compiler。
绝大多数的动态语言都是分成四部分的:the lexer,the parser,the interpreter and the runtime.
我们将要创造的语言叫Awesome，使用Ruby语法和Python缩进，长下面模样：
123456789101112131415">
<meta property="og:updated_time" content="2016-01-08T15:08:09.404Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Javascript学习12">
<meta name="twitter:description" content="languages are still build from a lexer,a parser and a compiler。
绝大多数的动态语言都是分成四部分的:the lexer,the parser,the interpreter and the runtime.
我们将要创造的语言叫Awesome，使用Ruby语法和Python缩进，长下面模样：
123456789101112131415">
  
    <link rel="alternative" href="/atom.xml" title="保的城" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="null" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Balsam</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Program | Design | Humor</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>標籤</li>
						
						
						<li>關於</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/balsamleo" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/no20lbc" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liao-bao-cheng" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="https://balsamleo@gmail.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/30天js/" style="font-size: 20px;">30天js</a> <a href="/tags/Angular/" style="font-size: 16.67px;">Angular</a> <a href="/tags/jQuery/" style="font-size: 10px;">jQuery</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/职业生涯/" style="font-size: 13.33px;">职业生涯</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">我，Learn By Using it.</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Balsam</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="null" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Balsam</h1>
			</hgroup>
			
			<p class="header-subtitle">Program | Design | Humor</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/balsamleo" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/no20lbc" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="https://www.zhihu.com/people/liao-bao-cheng" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="https://balsamleo@gmail.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-javascript-learn-12" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/javascript-learn-12/" class="article-date">
  	<time datetime="2015-12-30T15:06:53.000Z" itemprop="datePublished">2015-12-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Javascript学习12
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/30天js/">30天js</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>languages are still build from a lexer,a parser and a compiler。</p>
<p>绝大多数的动态语言都是分成四部分的:the lexer,the parser,the interpreter and the runtime.</p>
<p>我们将要创造的语言叫Awesome，使用Ruby语法和Python缩进，长下面模样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Awesome</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="string">"I'm Awesome"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">awesomeness</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="number">100</span></span><br><span class="line"></span><br><span class="line">awesome = Awesome.new</span><br><span class="line"></span><br><span class="line">print(awesome.name)</span><br><span class="line"></span><br><span class="line">print(awesome.awesomeness)</span><br></pre></td></tr></table></figure>
<p>我们这门语言的规则是：</p>
<p>1.代码块靠缩进</p>
<p>2.使用class关键字定义类</p>
<p>3.任何地方都可以定义方法，使用def关键字</p>
<p>4.大写开头的标记符是全局可访问的常量</p>
<p>5.小写开头的是局部变量</p>
<p>6.如果一个方法没有参数，小括号可省略，Ruby是如此的</p>
<p>7.所有都是对象</p>
<h2 id="Lexer">Lexer</h2><p>lexer，或者说scanner，tokenizer，用来把将要运行的代码转换成parser能理解的符号（tokens）</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">print "I ate",</span><br><span class="line"></span><br><span class="line"><span class="code">        3,</span></span><br><span class="line"></span><br><span class="line"><span class="code">        pies</span></span><br><span class="line"></span><br><span class="line">//代码通过lexer后是这样子的：</span><br><span class="line"></span><br><span class="line">[<span class="link_label">IDENTIFIER print</span>] [<span class="link_label">STRING "I ate"</span>] [<span class="link_label">COMMA</span>][<span class="link_reference">NUMBER 3</span>] [COMMA&#125;&#123;IDENTIFIER pies]</span><br></pre></td></tr></table></figure>
<p>分词器分割代码，让parser更好上手。可以用正则表达式实现分词器，更好用的一些工具也早有了</p>
<p><code>Flex</code>是Lex的现代版本，由谷歌CEOEric Schmidt实现的，用于C语言，跟yacc一样，Lex很流行啊。有Ruby版本的Rex，Java版本的JFlex。Lex的语法长下面模样</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BLANK	[ \t\n]+</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="comment">//Whitespace</span></span><br><span class="line"></span><br><span class="line">&#123;BLANK&#125;  <span class="comment">/*ignore*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Literals</span></span><br><span class="line"></span><br><span class="line">[<span class="number">0</span>-<span class="number">9</span>]+    yylval = atoi (yytext); <span class="keyword">return</span> T_NUMBER;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Keywords</span></span><br><span class="line"></span><br><span class="line"><span class="string">"end"</span>  yylval = yytext; <span class="keyword">return</span> T_END;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>左边是正则表达式，右边是相应动作。更多细节可以查看Flex Manual</p>
<a id="more"></a>
<h2 id="RAGEL">RAGEL</h2><p>Ragel是创建scanner的利器，State Machine Compiler：lexers，如同正则表达式那般，是一个状态机。下面是Ragel语法的样子：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">%%&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="atom">machine</span> <span class="atom">lexer</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="name">Machine</span></span><br><span class="line"></span><br><span class="line"><span class="atom">number</span>		= [<span class="number">0</span>-=]+;</span><br><span class="line"></span><br><span class="line"><span class="atom">whitespace</span>	= <span class="string">" "</span>;</span><br><span class="line"></span><br><span class="line"><span class="atom">keyword</span>		= <span class="string">"end"</span> | <span class="string">"def"</span> | <span class="string">"class"</span> | <span class="string">"if"</span> | <span class="string">"else"</span> | <span class="string">"true"</span> | <span class="string">"false"</span> | <span class="string">"nil"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="name">Actions</span></span><br><span class="line"></span><br><span class="line"><span class="atom">main</span> := |*</span><br><span class="line"></span><br><span class="line">	<span class="atom">whitespace</span>; #<span class="atom">ignore</span></span><br><span class="line"></span><br><span class="line">	<span class="atom">number</span>		=&gt;&#123; <span class="atom">tokens</span> &lt;&lt; [:<span class="name">NUMBER</span>,<span class="atom">data</span>[<span class="atom">ts</span>..<span class="atom">te</span>].<span class="atom">to_i</span>] &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="atom">keyword</span>		=&gt;&#123; <span class="atom">tokens</span> &lt;&lt; [<span class="atom">data</span>[<span class="atom">ts</span>...<span class="atom">te</span>].<span class="atom">upcase</span>.<span class="atom">to_sym</span>, <span class="atom">data</span>[<span class="atom">ts</span>...<span class="atom">te</span>]] &#125;;</span><br><span class="line"></span><br><span class="line">*|;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="atom">class</span> <span class="name">Lexer</span></span><br><span class="line"></span><br><span class="line">	<span class="atom">def</span> <span class="atom">initialize</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">%% write data;</span></span><br><span class="line"></span><br><span class="line">	<span class="atom">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="atom">def</span> <span class="atom">run</span>(<span class="atom">data</span>)</span><br><span class="line"></span><br><span class="line">		<span class="atom">eof</span> = <span class="atom">data</span>.<span class="atom">size</span></span><br><span class="line"></span><br><span class="line">		<span class="atom">line</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">		<span class="atom">tokens</span> = []</span><br><span class="line"></span><br><span class="line">		<span class="comment">%% write init;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">%% write exec;</span></span><br><span class="line"></span><br><span class="line">		<span class="atom">tokens</span></span><br><span class="line"></span><br><span class="line">	<span class="atom">end</span></span><br><span class="line"></span><br><span class="line"><span class="atom">end</span></span><br><span class="line"></span><br><span class="line">&#125;<span class="comment">%%</span></span><br></pre></td></tr></table></figure>
<p>更多细节可以看Ragel manual</p>
<p>Java版本是Min’s lexer，C版本是Potion’s lexer</p>
<h2 id="Python式的缩进">Python式的缩进</h2><p>我们的目的是理解scanner的概念，所以我们在正则表达式基础上实现一个lexer。 </p>
<p>下面的例子</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="prolog"><span class="atom">if</span> <span class="atom">tasty</span> == <span class="name">True</span>:</span><br><span class="line"></span><br><span class="line">	<span class="atom">print</span> <span class="string">"Delicious"</span></span><br><span class="line"></span><br><span class="line">//<span class="atom">yield</span> <span class="atom">those</span> <span class="atom">tokens</span></span><br><span class="line"></span><br><span class="line">[<span class="name">IDENTIFIER</span> <span class="atom">if</span>] [<span class="name">IDENTIFIER</span> <span class="atom">tasty</span>] [<span class="name">EQUAL</span>] [<span class="name">IDENTIFIER</span> <span class="name">True</span>]</span><br><span class="line"></span><br><span class="line">[<span class="name">INDENT</span>] [<span class="name">IDENTIFIER</span> <span class="atom">print</span>] [<span class="name">STRING</span> <span class="string">"Delicious!"</span>]</span><br><span class="line"></span><br><span class="line">[<span class="name">DEDENT</span>]</span></span><br></pre></td></tr></table></figure>
<p>代码块由INDENT和DEDENT包裹而不是{}。缩进解析算法很简单，只需要追踪两件事：当前缩进层级和整个缩进栈层级。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="ruby"><span class="class"><span class="keyword">class</span> <span class="title">Lexer</span></span></span><br><span class="line"></span><br><span class="line">	<span class="constant">KEYWORDS</span> = [<span class="string">"def"</span>,<span class="string">"class"</span>,<span class="string">"if"</span>,<span class="string">"true"</span>,<span class="string">"false"</span>,<span class="string">"nil"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">tokenize</span><span class="params">(code)</span>:</span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># cleanup code by remove extra line breaks</span></span><br><span class="line"></span><br><span class="line">		code.chmop!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment"># Current character position we're parsing</span></span><br><span class="line"></span><br><span class="line">		i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment"># Collections of all parsed tokens in the form [:TOKEN_TYPE, value]</span></span><br><span class="line"></span><br><span class="line">		tokens = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment"># Current indent level is the number of spaces in the last indent.</span></span><br><span class="line"></span><br><span class="line">		current_indent = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># we keep track of the indentation levels we are in so that when we dedent,we can </span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># check if we're on the correct level.</span></span><br><span class="line"></span><br><span class="line">		indent_stack = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment"># this is how to implement a very simple scanner.</span></span><br><span class="line"></span><br><span class="line">		<span class="comment"># scan one character at the time until you find something to parse.</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> i &lt; code.size</span><br><span class="line"></span><br><span class="line">			chunk = code[i..-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="comment">#matching standard tokens</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># matching if,print,method names,etc.</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> <span class="constant">Indentifier</span> = chunk[<span class="regexp">/\A([a-z]\w*)/</span>,<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">				<span class="comment"># keywords are specifial identifiers tagged with their own name,"if" will result</span></span><br><span class="line"></span><br><span class="line">				<span class="comment"># in an [:IF, "if"] token</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> <span class="constant">KEYWORDS</span>.<span class="keyword">include</span>?(identifier)</span><br><span class="line"></span><br><span class="line">					tokens &lt;&lt; [identifier.upcase.to_sym, identifier]</span><br><span class="line"></span><br><span class="line">				<span class="comment"># Non-keyword identifiers include method and variable names.</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">else</span> </span><br><span class="line"></span><br><span class="line">					tokens &lt;&lt; [<span class="symbol">:IDENTIFIER</span>, indentifier]</span><br><span class="line"></span><br><span class="line">				<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">				<span class="comment">#skip what we just parsed</span></span><br><span class="line"></span><br><span class="line">				i += identifier.size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="comment"># Matching class names and constants starting with a capital letter.</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">elsif</span> constant = chunk[<span class="regexp">/\A([A-Z]\W*)/</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">				tokens &lt;&lt; [<span class="symbol">:CONSTANT</span>, constant]</span><br><span class="line"></span><br><span class="line">				i += constant.size </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="keyword">elsif</span> string = chunk[<span class="regexp">/\A"(.*?)"/</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">				tokens &lt;&lt; [<span class="symbol">:STRING</span>, string]</span><br><span class="line"></span><br><span class="line">				i += string.size + <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="comment"># here is the indentation magic!</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># we have to take care of 3 cases</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">elsif</span> indent = chunk[<span class="regexp">/\A\:\n( +)/m</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">			<span class="comment"># above matchs ":&lt;newline&gt; &lt;spaces&gt;"</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># when we create a new block we expect the indent level to go up.</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> indent.size &lt;= current_indent</span><br><span class="line"></span><br><span class="line">					raise <span class="string">"Bad indent level, got <span class="subst">#&#123;indent.size&#125;</span> indents. "</span> +</span><br><span class="line"></span><br><span class="line">								<span class="string">"expected &gt; <span class="subst">#&#123;current_indent&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">				<span class="comment"># adjust the current indentation level.</span></span><br><span class="line"></span><br><span class="line">				current_indent = indent.size</span><br><span class="line"></span><br><span class="line">				indent_stack.push(current_indent)</span><br><span class="line"></span><br><span class="line">				tokens &lt;&lt; [<span class="symbol">:INDENT</span>, indent.size]</span><br><span class="line"></span><br><span class="line">				i += indent.size + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">elsif</span> indent = chunk[<span class="regexp">/\A\n( *)/m</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">			<span class="comment">#above matchs "&lt;newline&gt; &lt;spaces&gt;"</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> indent.size == current_indent <span class="comment"># case 2</span></span><br><span class="line"></span><br><span class="line">					tokens &lt;&lt; [<span class="symbol">:NEWLINE</span>,<span class="string">"\n"</span>]</span><br><span class="line"></span><br><span class="line">				<span class="keyword">elsif</span> indent.size &lt; current_indent <span class="comment"># case 3</span></span><br><span class="line"></span><br><span class="line">					<span class="keyword">while</span> indent.size &lt; current_indent</span><br><span class="line"></span><br><span class="line">						indent_stack.pop </span><br><span class="line"></span><br><span class="line">						current_indent = indent_stack.first || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">						tokens &lt;&lt; [<span class="symbol">:DEDENT</span>, indent.size]</span><br><span class="line"></span><br><span class="line">					<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">					tokens &lt;&lt; [<span class="symbol">:NEWLINE</span>, <span class="string">"\n"</span>]</span><br><span class="line"></span><br><span class="line">				<span class="keyword">else</span> <span class="comment"># indent.size &gt; current_indent, error</span></span><br><span class="line"></span><br><span class="line">					raise <span class="string">"Missing ':'"</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">				i += indent.size + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># match long operators such as || , &amp;&amp;, ==, !=, &lt;= and &gt;=.</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># one character long operators are matched by the catch all 'else' at the bottom.</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">elsif</span> operator = chunk[<span class="regexp">/\A(\|\||&amp;&amp;|==|!=|&lt;=|&gt;=)/</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">				tokens &lt;&lt; [operator, operator]</span><br><span class="line"></span><br><span class="line">				i += operator.size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="comment"># ignore whitespace</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">elsif</span> chunk.match(<span class="regexp">/\A /</span>)</span><br><span class="line"></span><br><span class="line">				i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># catch all single characters</span></span><br><span class="line"></span><br><span class="line">			<span class="comment"># we treat all other single characters as a token. Eg.:(),.</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">else</span> </span><br><span class="line"></span><br><span class="line">			  value = chunk[<span class="number">0</span>,<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">			  tokens &lt;&lt; [value, value]</span><br><span class="line"></span><br><span class="line">			  i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">	  <span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">	  <span class="comment"># close all open blocks </span></span><br><span class="line"></span><br><span class="line">	  <span class="keyword">while</span> indent = indent_stack.pop </span><br><span class="line"></span><br><span class="line">	    tokens &lt;&lt; [<span class="symbol">:DEDENT</span>, indent_stack.first || <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	  tokens </span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>很多parser同时处理lexing和parsing。</p>
<h2 id="PARSER">PARSER</h2><p>lexer生成tokens数组，parser生成节点树（a tree of nodes）</p>
<p>最常用的parser输出是AST(Abstract Syntax Tree).表现代码对该门语言的意义。</p>
<p>下面的例子</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// lexer</span></span><br><span class="line"></span><br><span class="line">[IDENTIFIER print]  [STRING <span class="string">"I ate"</span>] [COMMA]</span><br><span class="line"></span><br><span class="line">										[NUMBER <span class="number">3</span>] [COMMA]</span><br><span class="line"></span><br><span class="line">										[IDENTIFIER pies]</span><br><span class="line"></span><br><span class="line"><span class="comment">// parser</span></span><br><span class="line"></span><br><span class="line"><span class="annotation">[&lt;Call  name=print,</span><br><span class="line"></span><br><span class="line">				arguments=[&lt;String value="I ate"&gt;,</span><br><span class="line"></span><br><span class="line">				&lt;Number value=3&gt;,</span><br><span class="line"></span><br><span class="line">				&lt;Local name=pies&gt;]</span></span><br><span class="line"></span><br><span class="line">&gt;]</span><br></pre></td></tr></table></figure>
<p>图示则是：</p>
<p>parser生成器会将lexer tokens转换成AST nodes</p>
<h2 id="BISON(YACC)">BISON(YACC)</h2><p>Bison四应用最广的parser，Yacc的现代版本。Yacc表示Yet Another Compiler Compiler。Ruby版本是Racc，Python版本是Ply，Java版本是JavaCC。</p>
<p>下面是Yacc语法：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attribute">Call</span>: <span class="string">/* name of the rule */</span></span><br><span class="line"></span><br><span class="line"><span class="xquery">	Expression <span class="string">'.'</span> IDENTIFIER                   &#123; $$ = CallNode_new(<span class="variable">$1</span>, <span class="variable">$3</span>, NULL); &#125;</span><br><span class="line"></span><br><span class="line">	Expression <span class="string">'.'</span> IDENTIFIER  <span class="string">'('</span> Arglist <span class="string">')'</span>  &#123; $$ = CallNode_new(<span class="variable">$1</span>, <span class="variable">$3</span>, <span class="variable">$5</span>); &#125;</span><br><span class="line"></span><br><span class="line">	/* <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$3</span> <span class="variable">$4</span> <span class="variable">$5</span> <span class="variable">$6</span> &lt;= values from the rule are stored <span class="keyword">in</span> these variables.*/</span></span><br></pre></td></tr></table></figure>
<p>还有一个是<code>LEMON</code>，跟Yacc 很类似啦。还有<code>ANTLR</code></p>
<h2 id="PEGS">PEGS</h2><p>Parsing Expression Grammars，是一种强大的parsing语言。<code>Treetop</code>可用来实现Ruby的PEG</p>
<h2 id="OPERATOR_PRECEDENCE">OPERATOR PRECEDENCE</h2><p>操作符优先级，Yacc中是用<code>Shunting Yard algorithm</code>，通过<code>%left %right</code>来声明。</p>
<p>下面是操作符的一个案例，基于C语言</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attribute">left</span> <span class="string">'.'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">right</span> <span class="string">'!'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">left</span> <span class="string">'*'</span> <span class="string">'/'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">left</span> <span class="string">'+'</span> <span class="string">'-'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">left</span> <span class="string">'&gt;'</span> <span class="string">'&gt;='</span> <span class="string">'&lt;'</span> <span class="string">'&lt;='</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">left</span> <span class="string">'=='</span> <span class="string">'!='</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">left</span> <span class="string">'&amp;&amp;'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">left</span> <span class="string">'||'</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">right</span> <span class="string">'='</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">left</span> <span class="string">','</span></span><br></pre></td></tr></table></figure>
<p>越是上面的优先级越高。</p>
<h2 id="Awesome中的Lexer和Parser">Awesome中的Lexer和Parser</h2><p>我们的语言，我们使用Racc，Ruby版本的Yacc.从零开始搞一个parser比从零开始搞一个lexer难多了。大多数语言最终都是写一个自己的parser，为了更高效的处理结果和更齐全的错误提示。</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class <span class="type">Parser</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Declare tokens produced by the lexer</span></span><br><span class="line"></span><br><span class="line">token <span class="type">IF</span> <span class="type">ELSE</span></span><br><span class="line"></span><br><span class="line">token <span class="type">DEF</span></span><br><span class="line"></span><br><span class="line">token <span class="type">CLASS</span> </span><br><span class="line"></span><br><span class="line">token <span class="type">NEWLINE</span></span><br><span class="line"></span><br><span class="line">token <span class="type">NUMBER</span> </span><br><span class="line"></span><br><span class="line">token <span class="type">STRING</span> </span><br><span class="line"></span><br><span class="line">token <span class="type">TRUE</span> <span class="type">FALSE</span> <span class="type">NIL</span> </span><br><span class="line"></span><br><span class="line">token <span class="type">IDENTIFIER</span> </span><br><span class="line"></span><br><span class="line">token <span class="type">CONSTANT</span> </span><br><span class="line"></span><br><span class="line">token <span class="type">INDENT</span> <span class="type">DEDENT</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># precedence table </span></span><br><span class="line"></span><br><span class="line">prechigh</span><br><span class="line"></span><br><span class="line">left 	'.'</span><br><span class="line"></span><br><span class="line">right 	'!'</span><br><span class="line"></span><br><span class="line">left 	'*' '/'</span><br><span class="line"></span><br><span class="line">left 	'+' '-'</span><br><span class="line"></span><br><span class="line">left	'&gt;' '&gt;=' '&lt;='</span><br><span class="line"></span><br><span class="line">left	'==' '!='</span><br><span class="line"></span><br><span class="line">left	'&amp;&amp;'</span><br><span class="line"></span><br><span class="line">left 	'||'</span><br><span class="line"></span><br><span class="line">right	'='</span><br><span class="line"></span><br><span class="line">left	','</span><br><span class="line"></span><br><span class="line">preclow </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rule </span><br><span class="line"></span><br><span class="line"><span class="comment"># All rules are declared in this format</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># All Parsing will end in this rule, being the trunk of the AST </span></span><br><span class="line"></span><br><span class="line"><span class="type">Root</span>:</span><br><span class="line"></span><br><span class="line">	/*nothing*/					&#123;<span class="literal">result</span> = <span class="type">Nodes</span>.new([]) &#125;</span><br><span class="line"></span><br><span class="line">|	<span class="type">Expressions</span>					&#123; <span class="literal">result</span> = val[<span class="number">0</span>] &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Any list of expressions, class or method body, seperated by line breaks.</span></span><br><span class="line"></span><br><span class="line"><span class="type">Expressions</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">Expression</span> 					                &#123; <span class="literal">result</span> = <span class="type">Nodes</span>.new(val) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expressions</span> <span class="type">Terminator</span> <span class="type">Expression</span>   &#123; <span class="literal">result</span> = val[<span class="number">0</span>] &lt;&lt; val[<span class="number">2</span>] &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># To ignore trailing line breaks </span></span><br><span class="line"></span><br><span class="line">| <span class="type">Expressions</span> <span class="type">Terminator</span> &#123; <span class="literal">result</span> = val[<span class="number">0</span>] &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Terminator</span> &#123; <span class="literal">result</span> = <span class="type">Nodes</span>.new([]) &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">#All types of expressions in our language </span></span><br><span class="line"></span><br><span class="line"><span class="type">Expression</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">Literal</span> </span><br><span class="line"></span><br><span class="line">|	<span class="type">Call</span> </span><br><span class="line"></span><br><span class="line">|	<span class="type">Operator</span> </span><br><span class="line"></span><br><span class="line">| <span class="type">Constant</span> </span><br><span class="line"></span><br><span class="line">| <span class="type">Assign</span> </span><br><span class="line"></span><br><span class="line">| <span class="type">Def</span> </span><br><span class="line"></span><br><span class="line">| <span class="type">Class</span> </span><br><span class="line"></span><br><span class="line">| <span class="type">If</span> </span><br><span class="line"></span><br><span class="line">| '(' <span class="type">Expression</span> ')'	&#123; <span class="literal">result</span> = val[<span class="number">1</span>] &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># All tokens that can terminate an expression </span></span><br><span class="line"></span><br><span class="line"><span class="type">Terminator</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">NEWLINE</span> </span><br><span class="line"></span><br><span class="line">| <span class="string">":"</span></span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># All hard-coded values </span></span><br><span class="line"></span><br><span class="line"><span class="type">Literal</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">NUMBER</span> &#123; <span class="literal">result</span> = <span class="type">NumberNode</span>.new(val[<span class="number">0</span>]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">STRING</span> &#123; <span class="literal">result</span> = <span class="type">StringNode</span>.new(val[<span class="number">0</span>]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">TRUE</span> &#123; <span class="literal">result</span> = <span class="type">TrueNode</span>.new &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">FALSE</span> &#123; <span class="literal">result</span> = <span class="type">FalseNode</span>.new &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">NIL</span> &#123; <span class="literal">result</span> = <span class="type">NilNode</span>.new &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># A method call </span></span><br><span class="line"></span><br><span class="line"><span class="type">Call</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">#method </span></span><br><span class="line"></span><br><span class="line">	<span class="type">IDENTIFIER</span>  &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(<span class="keyword">nil</span>, val[<span class="number">0</span>], []) &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># method(arguments)</span></span><br><span class="line"></span><br><span class="line">| <span class="type">IDENTIFIER</span> <span class="string">"("</span> <span class="type">ArgList</span> <span class="string">")"</span>   &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(<span class="keyword">nil</span>, val[<span class="number">0</span>], val[<span class="number">2</span>]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> <span class="string">"."</span> <span class="type">IDENTIFIER</span>		&#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">2</span>], []) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> <span class="string">"."</span></span><br><span class="line"></span><br><span class="line">		<span class="type">IDENTIFIER</span> <span class="string">"("</span> <span class="type">ArgList</span> <span class="string">")"</span>  &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">2</span>], val[<span class="number">4</span>]) &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">ArgList</span>:</span><br><span class="line"></span><br><span class="line">	/* <span class="type">Nothing</span> */ 			&#123; <span class="literal">result</span> = [] &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span>          &#123; <span class="literal">result</span> = val &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">ArgList</span> <span class="string">","</span> <span class="type">Expression</span> &#123;<span class="literal">result</span> = val[<span class="number">0</span>]&lt;&lt;val[<span class="number">2</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Operator</span>:</span><br><span class="line"></span><br><span class="line"><span class="comment">#binary operator </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="type">Expression</span> '||' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '&amp;&amp;' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '==' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '!=' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '&gt;' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '&gt;=' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '&lt;' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '&lt;=' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '+' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '-' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '*' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">Expression</span> '/' <span class="type">Expression</span> &#123; <span class="literal">result</span> = <span class="type">CallNode</span>.new(val[<span class="number">0</span>], val[<span class="number">1</span>], [val[<span class="number">2</span>]]) &#125;   </span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Constant</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">CONSTANT</span> 			&#123; <span class="literal">result</span> = <span class="type">GetConstantNode</span>.new(val[<span class="number">0</span>]) &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Assignment to a variable or constant </span></span><br><span class="line"></span><br><span class="line"><span class="type">Assign</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">IDENTIFIER</span> <span class="string">"="</span> <span class="type">Expression</span>    &#123; <span class="literal">result</span> = <span class="type">SetLocalNode</span>.new(val[<span class="number">0</span>], val[<span class="number">2</span>]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">CONSTANT</span> <span class="string">"="</span> <span class="type">Expression</span>      &#123; <span class="literal">result</span> = <span class="type">SetConstantNode</span>.new(val[<span class="number">0</span>], val[<span class="number">2</span>]) &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># method definition </span></span><br><span class="line"></span><br><span class="line"><span class="type">Def</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">DEF</span> <span class="type">IDENTIFIER</span> <span class="type">Block</span> 				&#123; <span class="literal">result</span> = <span class="type">DefNode</span>.new(val[<span class="number">1</span>],[],val[<span class="number">2</span>]) &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">DEF</span> <span class="type">IDENTIFIER</span> </span><br><span class="line"></span><br><span class="line">	<span class="string">"("</span> <span class="type">ParamList</span> <span class="string">")"</span> <span class="type">Block</span>     &#123; <span class="literal">result</span> = <span class="type">DefNode</span>.new(val[<span class="number">1</span>], val[<span class="number">3</span>], val[<span class="number">5</span>]) &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">ParamList</span>:</span><br><span class="line"></span><br><span class="line">	/* nothing */          &#123; <span class="literal">result</span> = [] &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">IDENTIFIER</span>             &#123; <span class="literal">result</span> = val &#125;</span><br><span class="line"></span><br><span class="line">| <span class="type">ParamList</span> <span class="string">","</span> <span class="type">IDENTIFIER</span>  &#123; <span class="literal">result</span> = val[<span class="number">0</span>] &lt;&lt; val[<span class="number">2</span>] &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Class definition</span></span><br><span class="line"></span><br><span class="line"><span class="type">Class</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">CLASS</span> <span class="type">CONSTANT</span> <span class="type">Block</span>      &#123; <span class="literal">result</span> = <span class="type">ClassNode</span>.new(val[<span class="number">1</span>], val[<span class="number">2</span>])&#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># if block </span></span><br><span class="line"></span><br><span class="line"><span class="type">If</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">IF</span> <span class="type">Expression</span> <span class="type">Block</span>           &#123; <span class="literal">result</span> = <span class="type">IfNode</span>.new(val[<span class="number">1</span>], val[<span class="number">2</span>]) &#125;</span><br><span class="line"></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Block</span>:</span><br><span class="line"></span><br><span class="line">	<span class="type">INDENT</span> <span class="type">Expression</span> <span class="type">DEDENT</span>         &#123; <span class="literal">result</span> = val[<span class="number">1</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---- header </span><br><span class="line"></span><br><span class="line">	require <span class="string">"lexer"</span></span><br><span class="line"></span><br><span class="line">	require <span class="string">"nodes"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---- inner </span><br><span class="line"></span><br><span class="line">	def parse(code,show_tokens=<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">		@tokens = <span class="type">Lexer</span>.new.tokenize(code)</span><br><span class="line"></span><br><span class="line">		puts @tokens.inspect <span class="keyword">if</span> show_tokens</span><br><span class="line"></span><br><span class="line">		do_parse </span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	def next_token </span><br><span class="line"></span><br><span class="line">		@tokens.shift </span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="运行时（RUNTIME_MODEL）">运行时（RUNTIME MODEL）</h2><p>运行时模型，我们如何展现它的对象/方法/类型/内存结构。parser决定了你如何与编程语言对话，runtime则决定了编程语言相应的行为。两种语言可以有相同的parser，却是完全不同的runtime。</p>
<p>设计runtime时有三个因素要考虑：</p>
<ul>
<li><p>速度：很重要</p>
</li>
<li><p>灵活性：越灵活越强大</p>
</li>
<li><p>内存需求</p>
</li>
</ul>
<p>上面的三个因素是互斥的，所以设计语言时必须懂得取舍。考虑上述的因素，有好几种方式来实现runtime</p>
<h3 id="过程式_PROCEDURAL">过程式 PROCEDURAL</h3><p>很简单的一种runtime，C和PHP是如此，一切都围绕者函数。没有对象，所有函数都在同一个命名空间中，很快程序就会是一团糟。</p>
<h3 id="基于类_CLASS-BASED">基于类 CLASS-BASED</h3><p>当下最流行的模式，Java/Python/Ruby等等都是如此，有可能是最容易理解的模式。</p>
<h3 id="基于原型_PROTOTYPE-BASED">基于原型 PROTOTYPE-BASED</h3><p>除了Javascript，没有什么基于原型的语言流行起来了。这是种最容易实现的模式，也是最灵活的模式，因为万物都是对象的克隆。本书的最后有个简单的基于原型的语言：<code>Mio，a minimalist homoiconic language</code></p>
<h3 id="函数式_FUNCTIONAL">函数式 FUNCTIONAL</h3><p>Lisp等语言实现了函数式模式，Lambda运算子。</p>
<h3 id="我们Awesome的runtime">我们Awesome的runtime</h3><p>我们最熟悉基于类的编程语言，就用这个把。下面的代码定义了对象/方法/类，如何存储，如何交互。</p>
<p>AwesomeObject是我们最上层对象。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Represents an Awesome object instance in the Ruby world.</span><br><span class="line"></span><br><span class="line">class AwesomeObject </span><br><span class="line"></span><br><span class="line">	attr_accessor: runtime_class, :ruby_value </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	# each object have a class(named runtime_class to prevent errors with rubys class)</span><br><span class="line"></span><br><span class="line">	# Optionaly an object can hold a ruby value (numbers and strings)</span><br><span class="line"></span><br><span class="line">	def initialize(runtime_class, ruby_value = self)</span><br><span class="line"></span><br><span class="line">		@runtime_class = runtime_class</span><br><span class="line"></span><br><span class="line">		@ruby_value = ruby_value</span><br><span class="line"></span><br><span class="line">	<span class="operator"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	# <span class="keyword">call</span> a method <span class="keyword">on</span> the <span class="keyword">object</span> </span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="keyword">call</span>(method, arguments=[])</span><br><span class="line"></span><br><span class="line">		# <span class="keyword">like</span> a typical <span class="keyword">class</span>-based runtime <span class="keyword">model</span>.we <span class="keyword">store</span> methods <span class="keyword">in</span> the <span class="keyword">class</span> <span class="keyword">of</span> the <span class="keyword">object</span> </span><br><span class="line"></span><br><span class="line">		@runtime_class.lookup(method).<span class="keyword">call</span>(<span class="keyword">self</span>,arguments)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Represents a awesome <span class="keyword">class</span> <span class="keyword">in</span> the ruby world.Classes <span class="keyword">are</span> <span class="keyword">object</span> <span class="keyword">in</span> awesome so they inherit <span class="keyword">from</span> awesomeobject </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> AwesomeClass &lt; AwesomeObject </span><br><span class="line"></span><br><span class="line">	attr_reader: runtime_methods </span><br><span class="line"></span><br><span class="line">	# creates a <span class="keyword">new</span> <span class="keyword">class</span>. <span class="built_in">Number</span> <span class="keyword">is</span> an <span class="keyword">instance</span> <span class="keyword">of</span> <span class="keyword">class</span> <span class="keyword">for</span> example.</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> initialize</span><br><span class="line"></span><br><span class="line">		@runtime_methods = &#123;&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> defined?(Runtime)</span><br><span class="line"></span><br><span class="line">			runtime_class=Runtime[<span class="string">"Class"</span>]</span><br><span class="line"></span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line"></span><br><span class="line">			runtime_class = nil </span><br><span class="line"></span><br><span class="line">		<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">		super(runtime_class)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	# Lookup a method </span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> lookup(method_name)</span><br><span class="line"></span><br><span class="line">		method = @runtime_methods[method_name]</span><br><span class="line"></span><br><span class="line">		unless method </span><br><span class="line"></span><br><span class="line">			<span class="keyword">raise</span> <span class="string">"Method not found: #&#123;method_name&#125;"</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">		method </span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	# <span class="keyword">create</span> a <span class="keyword">new</span> <span class="keyword">instance</span> <span class="keyword">of</span> this <span class="keyword">class</span> </span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="keyword">new</span> </span><br><span class="line"></span><br><span class="line">		AwesomeObject.<span class="keyword">new</span>(<span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	# <span class="keyword">create</span> an <span class="keyword">instance</span> <span class="keyword">of</span> this awesome <span class="keyword">class</span> that holds a ruby <span class="keyword">value</span>.<span class="keyword">like</span> a <span class="keyword">string</span>,<span class="built_in">number</span> <span class="keyword">or</span> <span class="literal">true</span>.</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> new_with_value(<span class="keyword">value</span>)</span><br><span class="line"></span><br><span class="line">		AwesomeObject.<span class="keyword">new</span>(<span class="keyword">self</span>, <span class="keyword">value</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># represents a method defined <span class="keyword">in</span> the runtime </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> AwesomeMethod </span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> initialize(params,<span class="keyword">body</span>)</span><br><span class="line"></span><br><span class="line">		@params = params </span><br><span class="line"></span><br><span class="line">		@<span class="keyword">body</span> = <span class="keyword">body</span> </span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="keyword">call</span>(receiver, arguments)</span><br><span class="line"></span><br><span class="line">		# <span class="keyword">create</span> a <span class="keyword">context</span> <span class="keyword">of</span> evaluation <span class="keyword">in</span> which the method will <span class="keyword">execute</span>.</span><br><span class="line"></span><br><span class="line">		<span class="keyword">context</span> = <span class="keyword">Context</span>.<span class="keyword">new</span>(receiver)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		#Assign arguments <span class="keyword">to</span> <span class="keyword">local</span> <span class="keyword">variables</span> </span><br><span class="line"></span><br><span class="line">		@params.each_with_index <span class="keyword">do</span> |param, <span class="keyword">index</span>|</span><br><span class="line"></span><br><span class="line">			<span class="keyword">context</span>.locals[param] = arguments[<span class="keyword">index</span>]</span><br><span class="line"></span><br><span class="line">		<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">		@<span class="keyword">body</span>.eval(<span class="keyword">context</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">p</span> = proc <span class="keyword">do</span> |arg1, arg2|</span><br><span class="line"></span><br><span class="line">	#...</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">p</span>.<span class="keyword">call</span>(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="keyword">Context</span> </span><br><span class="line"></span><br><span class="line">	attr_reader: locals, :current_self, :current_class </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> initialize(current_self,current_class=current_self.runtime_class)</span><br><span class="line"></span><br><span class="line">		@locals = &#123;&#125;</span><br><span class="line"></span><br><span class="line">		@current_self = current_self </span><br><span class="line"></span><br><span class="line">		@current_class = current_class </span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> [](<span class="keyword">name</span>)</span><br><span class="line"></span><br><span class="line">		@@constants[<span class="keyword">name</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> []=(<span class="keyword">name</span>,<span class="keyword">value</span>)</span><br><span class="line"></span><br><span class="line">		@@constants[<span class="keyword">name</span>] = <span class="keyword">value</span> </span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">awesome_class = AwesomeClass.<span class="keyword">new</span>   #<span class="keyword">Class</span></span><br><span class="line"></span><br><span class="line">awesome_class.runtime_class = awesome_class # <span class="keyword">Class</span>.<span class="keyword">class</span> = <span class="keyword">Class</span></span><br><span class="line"></span><br><span class="line">object_class = AwesomeClass.<span class="keyword">new</span> # <span class="keyword">Object</span> = <span class="keyword">Class</span>.<span class="keyword">new</span></span><br><span class="line"></span><br><span class="line">object_class.runtime_class = awesome_class # <span class="keyword">Object</span>.<span class="keyword">class</span> = <span class="keyword">Class</span></span><br><span class="line"></span><br><span class="line">Runtime = <span class="keyword">Context</span>.<span class="keyword">new</span>(object_class.<span class="keyword">new</span>)</span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"Class"</span>] = awesome_class</span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"Object"</span>] = object_class</span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"Number"</span>] = AwesomeClass.<span class="keyword">new</span></span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"String"</span>] = AwesomeClass.<span class="keyword">new</span></span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"TrueClass"</span>] = AwesomeClass.<span class="keyword">new</span></span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"FalseClass"</span>] = AwesomeClass.<span class="keyword">new</span></span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"NilClass"</span>] = AwesomeClass.<span class="keyword">new</span></span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"true"</span>] = Runtime[<span class="string">"TrueClass"</span>].new_with_value(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"false"</span>] = Runtime[<span class="string">"FalseClass"</span>].new_with_value(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"nil"</span>] = Runtime[<span class="string">"NilClass"</span>].new_with_value(nil)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"Class"</span>].runtime_methods[<span class="string">"new"</span>] = proc <span class="keyword">do</span> |receiver, arguments|</span><br><span class="line"></span><br><span class="line">	receiver.<span class="keyword">new</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Runtime[<span class="string">"Object"</span>].runtime_methods[<span class="string">"print"</span>]=proc <span class="keyword">do</span> |receiver, arguments|</span><br><span class="line"></span><br><span class="line">	puts arguments.<span class="keyword">first</span>.ruby_value </span><br><span class="line"></span><br><span class="line">	Runtime[<span class="string">"nil"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> = Runtime[<span class="string">"Object"</span>].<span class="keyword">call</span>(<span class="string">"new"</span>)</span><br><span class="line"></span><br><span class="line">assert_equal Runtime[<span class="string">"Object"</span>], objecct.runtime_class #assert <span class="keyword">object</span> <span class="keyword">is</span> an <span class="keyword">object</span></span></span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/01/javascript-learn-13/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Javascript学习13
        
      </div>
    </a>
  
  
    <a href="/2015/12/javascript-learn-11/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Javascript学习1229</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="javascript-learn-12" data-title="Javascript学习12" data-url="http:www.balsam.xyz/2015/12/javascript-learn-12/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"flase"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Balsam
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>